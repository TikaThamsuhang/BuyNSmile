<!DOCTYPE html>
<html>
  <head>
    <title>Chatbot
    </title>
    <style>
      body{
        font-family: Arial, sans-serif;
        margin: 0;
      }
      .btn {
        background-color: rgb(25, 135, 84);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 10px;
        cursor: pointer;
        margin-left: 10px;
        font-size: 15px;
      }

      .chat-input{
        padding: 12px 20px;
        border-radius: 10px;
        border: 1px solid grey;
        font-size: 15px;
        flex-grow: 1;
      }

      .chat-input-container{
        display: flex;
        margin-bottom: 60px;
      }

      .app-container{
        display: flex;
        max-width: 600px;
        margin: auto;
        height: 100vh;
        flex-direction: column;
      }

      .user-message, .robot-message{
        display: flex;
        align-items: start;

      }

      .user-message{
        justify-content: end;
      }

      .chat-message-text{
        background-color: rgb(238,238,238);
        padding: 15px 20px;
        border-radius: 10px;
        margin-left: 10px;
        margin-right: 10px;
        max-width: 300px;
        margin-bottom: 20px;
      }

      .chat-profile{
        width: 45px;
      }

      .chat-container{
        flex-grow: 1; 
        margin-top: 20px;
        overflow: scroll;
        scrollbar-width: none; 
      }

      .welcome-message {
        text-align: center;
        color: #666;
        margin: 20px 0;
        font-size: 18px;
      }

      .loading-spinner {
        margin: -15px;
        height: 40px;
      }
    </style>
  </head>
  <body>
    <!-- This is the container div where our React app will be rendered -->
    <div class="js-container"></div>
    

    <!-- Importing React library (core of React) -->
    <script src="https://unpkg.com/supersimpledev/react.js"></script> 
    <script src="https://unpkg.com/supersimpledev/chatbot.js"></script> 

    <!-- Importing ReactDOM library (used to render React elements into the DOM) -->
    <script src="https://unpkg.com/supersimpledev/react-dom.js"></script>

    <!-- Importing Babel (transpiler that converts JSX into JavaScript) -->
    <script src="https://unpkg.com/supersimpledev/babel.js"></script> 

    <script src="https://unpkg.com/supersimpledev/dayjs.js"></script>

    <!-- We write JSX code here. 
         type="text/babel" means Babel will convert it into plain JS so browsers understand -->
    <script type="text/babel"> 
      
      function ChatInput({ chatMessages, setChatMessages }){
        const [inputText, setInputText] = React.useState("");
        function saveInputText(event){
          setInputText(event.target.value);
        }

        async function sendMessage(){
          const newChatMessages = [
            ...chatMessages, // spread operator (...) is used to copy all existing chat messages into the new array.
            { message: inputText, sender: "user", id: crypto.randomUUID() }
          ];
          setChatMessages(newChatMessages);

          setChatMessages([
            ...newChatMessages, // spread operator (...) is used to copy all existing chat messages into the new array.
            { message: <img src="../loading-spinner.gif" className="loading-spinner" />, sender: "robot", id: crypto.randomUUID() }
          ]);
            
         

          const response = await Chatbot.getResponseAsync(inputText);
          setChatMessages([
            ...newChatMessages, // spread operator (...) is used to copy all existing chat messages into the new array.
            { message: response, sender: "robot", id: crypto.randomUUID() }
          ]);
          

          setInputText(""); // Clear the input field after sending the message.
        }

        return(
          <div className="chat-input-container">
            <input 
              placeholder="Send a message to chatbot" 
              size="30"
              onChange={saveInputText} 
              value={inputText}
              className="chat-input"
            /> 
            <button onClick={sendMessage} className="btn">Send</button>
          </div>
        );
      }

      function ChatMessage({message, sender}){
        return(
          <div className={sender === 'user' ? 'user-message' : 'robot-message'}>  
            {sender === 'robot' && (
              <img src="../robot.png" alt="" className='chat-profile'/>
            )}   
            <div className='chat-message-text'>   
              {message}
            </div>
            {sender === 'user' && (
              <img src="../user.png" alt="" className='chat-profile'/>
            )}  
          </div>
        );
        
      }

      // To use a function as a hook, the function name must
      // start with "use".
      function useAutoScroll(dependencies) {
        // It's highly recommend to rename this to something
        // more generic like containerRef. This will make the
        // code make more sense if we ever reuse this code in
        // other components.
        const containerRef = React.useRef(null);

        React.useEffect(() => {

          const containerElem = containerRef.current;
          if (containerElem) {
            containerElem.scrollTop = containerElem.scrollHeight;
          }
        }, dependencies);

        return containerRef;
      }

      function ChatMessages({chatMessages}){

        const chatMessagesRef = useAutoScroll([chatMessages]); // Create a ref to the chat messages container div

        return(
          <div className='chat-container' ref={chatMessagesRef}>
            {chatMessages.length === 0 ? (
              <p className="welcome-message">
                Welcome to the chatbot. Use the text box below to message.
              </p>
            ) : (
              chatMessages.map((chatMessage) => (
                <ChatMessage
                  message={chatMessage.message}
                  sender={chatMessage.sender}
                  key={chatMessage.id}
                />
              ))
            )}
          </div>
        );
      }

      function App(){
        const [chatMessages, setChatMessages] = React.useState(
          []
        );

        return(
          <div className="app-container">
            
            <ChatMessages 
              chatMessages={chatMessages} 
            />

            <ChatInput 
              chatMessages={chatMessages} 
              setChatMessages={setChatMessages}
            />
          </div>
        );
      }

      
      // Select the container div from HTML using querySelector
      const container = document.querySelector('.js-container');

      // Render the React element (div) into the container using ReactDOM
      ReactDOM.createRoot(container).render(<App />);

    </script>
  </body>
</html>
